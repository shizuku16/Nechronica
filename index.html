<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ネクロニカのキャラコマを作る</title>
    <script type="text/JavaScript">     
        function download(writeString){
            let bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            let blob = new Blob([bom, writeString],{type:"application/xml"});
            let link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'キャラコマ.xml';
            link.click();
        }

        
    var unicodeUnescape = function(str) {
        str=str.replace(/\\u/g,"0x")
        var str2=""
        for(;str.match(/./);){
            if(str.match(/^0x/)){
                var str3=str.match(/0x.{4}/g);
                str2+=String.fromCharCode(str3[0]);
                str=str.slice(6);
            }else{
                var str3=str.match(/.{1}/g);
                str2+=str3[0];
                str=str.slice(1);
            }
        }
        return str2;
    };        

    function yomikomi() {
        var date=document.getElementById("nyuryoku").value
        date=date.replace(/\s/g,"").replace(/、/g,",").replace(/：/,":")
        var bui=date.match(/\"V_Power_hantei\".*?\]/g)
        bui=bui[0].match(/\d+/g)

        var buimei=date.match(/Power_name.*?P/g)
        buimei=buimei[0].replace(/Power_name\":\[/,"").replace(/\]/,"").replace(/P/,"")
        buimei=buimei.match(/\".*?,/g)
        buimei.forEach(function(element,index,array){
            buimei[index]=buimei[index].replace(/,/g,"").replace(/\"/g,"")
            buimei[index]=unicodeUnescape(buimei[index])
                })

        var lost=date.match(/Power_Lost.*?\]/g)
        lost=lost[0].match(/\d+/g)

        var name=date.match(/pc_name.*?,/g)
        name=name[0].replace(/pc_name\":\"/,"").replace(/\",/,"")
        name=unicodeUnescape(name)

        var timing=date.match(/Power_timing.*?V/g)
        timing=timing[0].match(/\d+/g)
        timinglist=["オート","アクション","ジャッジ","ダメージ","ラピッド"]

        var cost=date.match(/,\"Power_cost.*?P/g)
        cost=cost[0].replace(/Power_cost\":\[/,"").replace(/\]/,"").replace(/P/,"")
        cost=cost.match(/\".*?,/g)
        cost.forEach(function(element,index,array){
            cost[index]=cost[index].replace(/,/g,"").replace(/\"/g,"")
            cost[index]=unicodeUnescape(cost[index])
                })

        var range=date.match(/Power_range.*?P/g)
        range=range[0].replace(/Power_range\":\[/,"").replace(/\]/,"").replace(/P/,"")
        range=range.match(/\".*?,/g)
        range.forEach(function(element,index,array){
            range[index]=range[index].replace(/,/g,"").replace(/\"/g,"")
            range[index]=unicodeUnescape(range[index])
                })

        var memo=date.match(/Power_memo.*?P/g)
        memo=memo[0].replace(/Power_memo\":\[/,"").replace(/\]/,"").replace(/P/,"")
        memo=memo.match(/\".*?,/g)
        memo.forEach(function(element,index,array){
            memo[index]=memo[index].replace(/,/g,"").replace(/\"/g,"")
            memo[index]=unicodeUnescape(memo[index])
                })

        var kyouki=date.match(/,\"roice_name.*?\"sl/g)
        kyouki=kyouki[0].replace(/\"roice_name\":\[/,"")
        kyouki=kyouki.match(/\".*?,/g)
        kyouki.forEach(function(element,index,array){
            kyouki[index]=kyouki[index].replace(/,/g,"").replace(/\"/g,"").replace(/]/g,"")
            kyouki[index]=unicodeUnescape(kyouki[index])
        })

        var kyoukisuu=date.match(/roice_damage.*?r/g)
        kyoukisuu=kyoukisuu[0].match(/\".*?,/g)
        console.log(kyoukisuu)
        kyoukisuu.forEach(function(element,index,array){
            kyoukisuu[index]=kyoukisuu[index].replace(/,/g,"").replace(/\"/g,"").replace(/:\[/,"").replace(/\]/,"")
            kyoukisuu[index]=unicodeUnescape(kyoukisuu[index])
        })

        var kakerakazu=date.match(/kakera_name.*?kakera_memo/g)
        kakerakazu=kakerakazu[0].match(/,/g)

        var koudouti=date.match(/Act_Total\":\"\d+/g)
        koudouti=koudouti[0].match(/\d+/g)
        koudouti=koudouti[0]
        console.log(koudouti)
        

        var skill=[]
        var atama=[]
        var ude=[]
        var doutai=[]
        var asi=[]
        var atamalost=[]
        var udelost=[]
        var doutailost=[]
        var asilost=[]
        var skilltiming=[]
        var atamatiming=[]
        var udetiming=[]
        var doutaitiming=[]
        var asitiming=[]

        for(i=0;i<bui.length;i++){
            if (bui[i]=="1"||bui[i]=="2"||bui[i]=="3") {
                skill.push(buimei[i])
                skilltiming.push(timing[i])
            }
            if(bui[i]=="4"){
                atama.push(buimei[i])
                atamalost.push(lost[i])
                atamatiming.push(timing[i])
            }
            if(bui[i]=="5"){
                ude.push(buimei[i])
                udelost.push(lost[i])
                udetiming.push(timing[i])
            }
            if(bui[i]=="6"){
                doutai.push(buimei[i])
                doutailost.push(lost[i])
                doutaitiming.push(timing[i])
            }
            if(bui[i]=="7"){
                asi.push(buimei[i])
                asilost.push(lost[i])
                asitiming.push(timing[i])
            }
        }
        console.log(udetiming)

    


        let writeString="<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<character>\n  <data name=\"character\">\n    <data name=\"image\">\n      <data type=\"image\" name=\"imageIdentifier\"></data>\n    </data>\n    <data name=\"common\">\n      <data name=\"name\">"+name+"</data>\n      <data name=\"size\">1</data>\n    </data>\n    <data name=\"detail\">\n"
        writeString+="      <data name=\"リソース\">\n        <data name=\"行動値\">"+koudouti+"</data>\n        <data type=\"numberResource\" currentValue=\"0\" name=\"狂気点回復\">"+kakerakazu.length+"</data>\n"
        writeString+="        <data type=\"numberResource\" currentValue=\"200\" name=\"未練\">200\n"
        for(i=0;i<kyouki.length;i++){
            if(kyouki[i]===""){}else{
                writeString+="          <data name=\""+kyouki[i]+"\" type=\"numberResource\" currentValue=\""+kyoukisuu[i]+"\">4</data>\n"
            }
        }
        
        writeString+="        </data>\n      </data>\n      <data name=\"頭\">\n"
            for(i=0;i<atama.length;i++){
                if(atamatiming[i]<2){
                    writeString+="        <data name=\""+atama[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+atamalost[i]+"\">1</data>\n        </data>\n"
                }else{
                    writeString+="        <data name=\""+atama[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+atamalost[i]+"\">1</data>\n          <data name=\"使用\" type=\"numberResource\" currentValue=\"0\">1</data>\n        </data>\n"
                }
            }
        
        
        writeString+="      </data>\n      <data name=\"腕\">\n"
        for(i=0;i<ude.length;i++){
            if(udetiming[i]<2){
                writeString+="        <data name=\""+ude[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+udelost[i]+"\">1</data>\n        </data>\n"
            }else{
                writeString+="        <data name=\""+ude[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+udelost[i]+"\">1</data>\n          <data name=\"使用\" type=\"numberResource\" currentValue=\"0\">1</data>\n        </data>\n"
            }
        }

        writeString+="      </data>\n      <data name=\"胴体\">\n"
        for(i=0;i<doutai.length;i++){
            if(doutaitiming[i]<2){
                writeString+="        <data name=\""+doutai[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+doutailost[i]+"\">1</data>\n        </data>\n"
            }else{
            writeString+="        <data name=\""+doutai[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+doutailost[i]+"\">1</data>\n          <data name=\"使用\" type=\"numberResource\" currentValue=\"0\">1</data>\n        </data>\n"
            }
        }

        writeString+="      </data>\n      <data name=\"脚\">\n"
        for(i=0;i<asi.length;i++){
            if(asitiming[i]<2){
                writeString+="        <data name=\""+asi[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+asilost[i]+"\">1</data>\n        </data>\n"
            }else{
            writeString+="        <data name=\""+asi[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+asilost[i]+"\">1</data>\n          <data name=\"使用\" type=\"numberResource\" currentValue=\"0\">1</data>\n        </data>\n"
            }
        }

        writeString+="      </data>\n      <data name=\"スキル\">\n"
        for(i=0;i<skill.length;i++){
            if(skilltiming[i]<2){
            }else{
                writeString+="        <data name=\""+skill[i]+"\" type=\"numberResource\">\n          <data name=\"使用\" type=\"numberResource\" currentValue=\"0\">1</data>\n        </data>\n"
            }
        }

        writeString+="      </data>\n    </data>\n  </data>\n  <chat-palette dicebot=\"Nechronica\">1NC　判定\n1NA　攻撃判定\n\n\nマニューバ/タイミング/コスト/射程/効果\n"
        for(i=0;i<memo.length;i++){
            if(memo[i].match(/^\d$/)||memo[i].match(/^最大行動値.{2}/)){}else if(memo[i].match(/.+/g)){
                writeString+="\n"+buimei[i]+"/"+timinglist[Number(timing[i])]+"/"+cost[i]+"/"+range[i]+"/"+memo[i]
            }
        }
            
        writeString+="</chat-palette>\n  </character>"
        console.log(writeString)

         download(writeString)

    }

    </script>
</head>
<body>
     キャラクターシートのURLの末尾に.jsを付けて開いたページの内容を、全てコピーして下の欄にペーストしてください。  <br>
     その後、ボタンをクリックするとxmlファイルをダウンロードします。xmlファイルをユドナリウムにペーストするとキャラコマができます。
    <br><textarea id="nyuryoku"  rows="10" cols="30"></textarea>
    <input type="button" onclick="yomikomi()" value="クリック">
</body>
</html>
