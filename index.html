<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ネクロニカのキャラコマを作る</title>
    <script type="text/JavaScript">     
        function download(writeString){
            let bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            let blob = new Blob([bom, writeString],{type:"application/xml"});
            let link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'キャラコマ.xml';
            link.click();
        }      

    function yomikomi() {
        var date=document.getElementById("nyuryoku").value
        var jsondate=JSON.parse(date)
        
        var bui=jsondate.V_Power_hantei
        var buimei=jsondate.Power_name
        var lost=jsondate.Power_Lost
        var name=jsondate.pc_name
        var timing=jsondate.Power_timing
        timinglist=["オート","アクション","ジャッジ","ダメージ","ラピッド"]
        var cost=jsondate.Power_cost
        var range=jsondate.Power_range
        var memo=jsondate.Power_memo
        var kyouki=jsondate.roice_name
        var kyoukisuu=jsondate.roice_damage
        var kakerakazu=jsondate.kakera_name
        var koudouti=jsondate.Act_Total

        var skill=[]
        var atama=[]
        var ude=[]
        var doutai=[]
        var asi=[]
        var atamalost=[]
        var udelost=[]
        var doutailost=[]
        var asilost=[]
        var skilltiming=[]
        var atamatiming=[]
        var udetiming=[]
        var doutaitiming=[]
        var asitiming=[]

        for(i=0;i<bui.length;i++){
            if (bui[i]=="1"||bui[i]=="2"||bui[i]=="3") {
                skill.push(buimei[i])
                skilltiming.push(timing[i])
            }
            if(bui[i]=="4"){
                atama.push(buimei[i])
                atamalost.push(lost[i])
                atamatiming.push(timing[i])
            }
            if(bui[i]=="5"){
                ude.push(buimei[i])
                udelost.push(lost[i])
                udetiming.push(timing[i])
            }
            if(bui[i]=="6"){
                doutai.push(buimei[i])
                doutailost.push(lost[i])
                doutaitiming.push(timing[i])
            }
            if(bui[i]=="7"){
                asi.push(buimei[i])
                asilost.push(lost[i])
                asitiming.push(timing[i])
            }
        }
        console.log(udetiming)

    


        let writeString="<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<character>\n  <data name=\"character\">\n    <data name=\"image\">\n      <data type=\"image\" name=\"imageIdentifier\"></data>\n    </data>\n    <data name=\"common\">\n      <data name=\"name\">"+name+"</data>\n      <data name=\"size\">1</data>\n    </data>\n    <data name=\"detail\">\n"
        writeString+="      <data name=\"リソース\">\n        <data name=\"行動値\">"+koudouti+"</data>\n        <data type=\"numberResource\" currentValue=\"0\" name=\"狂気点回復\">"+kakerakazu.length+"</data>\n"
        writeString+="        <data type=\"numberResource\" currentValue=\"200\" name=\"未練\">200\n"
        for(i=0;i<kyouki.length;i++){
            if(kyouki[i]===""){}else{
                writeString+="          <data name=\""+kyouki[i]+"\" type=\"numberResource\" currentValue=\""+kyoukisuu[i]+"\">4</data>\n"
            }
        }
        
        writeString+="        </data>\n      </data>\n      <data name=\"頭\">\n"
            for(i=0;i<atama.length;i++){
                if(atamatiming[i]<2){
                    writeString+="        <data name=\""+atama[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+atamalost[i]+"\">1</data>\n        </data>\n"
                }else{
                    writeString+="        <data name=\""+atama[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+atamalost[i]+"\">1</data>\n          <data name=\"使用\" type=\"numberResource\" currentValue=\"0\">1</data>\n        </data>\n"
                }
            }
        
        
        writeString+="      </data>\n      <data name=\"腕\">\n"
        for(i=0;i<ude.length;i++){
            if(udetiming[i]<2){
                writeString+="        <data name=\""+ude[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+udelost[i]+"\">1</data>\n        </data>\n"
            }else{
                writeString+="        <data name=\""+ude[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+udelost[i]+"\">1</data>\n          <data name=\"使用\" type=\"numberResource\" currentValue=\"0\">1</data>\n        </data>\n"
            }
        }

        writeString+="      </data>\n      <data name=\"胴体\">\n"
        for(i=0;i<doutai.length;i++){
            if(doutaitiming[i]<2){
                writeString+="        <data name=\""+doutai[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+doutailost[i]+"\">1</data>\n        </data>\n"
            }else{
            writeString+="        <data name=\""+doutai[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+doutailost[i]+"\">1</data>\n          <data name=\"使用\" type=\"numberResource\" currentValue=\"0\">1</data>\n        </data>\n"
            }
        }

        writeString+="      </data>\n      <data name=\"脚\">\n"
        for(i=0;i<asi.length;i++){
            if(asitiming[i]<2){
                writeString+="        <data name=\""+asi[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+asilost[i]+"\">1</data>\n        </data>\n"
            }else{
            writeString+="        <data name=\""+asi[i]+"\" type=\"numberResource\">\n          <data name=\"損傷\" type=\"numberResource\" currentValue=\""+asilost[i]+"\">1</data>\n          <data name=\"使用\" type=\"numberResource\" currentValue=\"0\">1</data>\n        </data>\n"
            }
        }

        writeString+="      </data>\n      <data name=\"スキル\">\n"
        for(i=0;i<skill.length;i++){
            if(skilltiming[i]<2){
            }else{
                writeString+="        <data name=\""+skill[i]+"\" type=\"numberResource\">\n          <data name=\"使用\" type=\"numberResource\" currentValue=\"0\">1</data>\n        </data>\n"
            }
        }

        writeString+="      </data>\n    </data>\n  </data>\n  <chat-palette dicebot=\"Nechronica\">1NC　判定\n1NA　攻撃判定\n\n\nマニューバ/タイミング/コスト/射程/効果\n"
        for(i=0;i<memo.length;i++){
            if(memo[i].match(/^\d$/)||memo[i].match(/^最大行動値.{2}/)){}else if(memo[i].match(/.+/g)){
                writeString+="\n"+buimei[i]+"/"+timinglist[Number(timing[i])]+"/"+cost[i]+"/"+range[i]+"/"+memo[i]
            }
        }
            
        writeString+="</chat-palette>\n  </character>"
        console.log(writeString)

         download(writeString)

    }

    </script>
</head>
<body>
     キャラクターシートのURLの末尾に.jsを付けて開いたページの内容を、全てコピーして下の欄にペーストしてください。  <br>
     その後、ボタンをクリックするとxmlファイルをダウンロードします。そのファイルをzipファイルに圧縮するとキャラコマができます。
    <br><textarea id="nyuryoku"  rows="10" cols="30"></textarea>
    <input type="button" onclick="yomikomi()" value="クリック">
</body>
</html>
